{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Hub - Panesar PG{% endblock %}

{% block extra_head %}
<style>
  /* Analytics Specific Refinements */
  .perf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .perf-chart-container {
    background: var(--bg-canvas);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
  }

  .data-table-luxury {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-canvas);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .data-table-luxury th {
    background: var(--bg-main);
    padding: 1rem;
    text-align: left;
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 800;
    color: var(--text-muted);
  }

  .data-table-luxury td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 0.875rem;
  }

  .metric-bubble {
    padding: 0.5rem 1rem;
    background: var(--primary-light);
    border-radius: 99px;
    color: var(--primary);
    font-weight: 800;
    font-size: 0.75rem;
  }

  @media (max-width: 768px) {

    .data-table-luxury,
    .data-table-luxury thead,
    .data-table-luxury tbody,
    .data-table-luxury th,
    .data-table-luxury td,
    .data-table-luxury tr {
      display: block;
    }

    .data-table-luxury thead {
      display: none;
    }

    .data-table-luxury tr {
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 1rem;
    }

    .data-table-luxury td {
      border: none;
      padding: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .data-table-luxury td::before {
      content: attr(data-label);
      font-weight: 800;
      color: var(--text-muted);
      font-size: 0.75rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<header class="card-premium glass-panel" style="margin-bottom: 2.5rem; padding: 2.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1 class="font-luxury text-luxury" style="font-size: 2.5rem;">Analytics Hub</h1>
      <p style="color: var(--text-muted); font-weight: 500;">Financial performance and occupancy health metrics.</p>
    </div>
    <div style="display: flex; gap: 1rem;">
      <button onclick="window.print()" class="btn-premium btn-premium-secondary">Export Report</button>
      <a href="{% url 'dashboard' %}" class="btn-premium btn-premium-secondary">← Dashboard</a>
    </div>
  </div>
</header>

<div class="stat-row">
  <div class="card-premium stat-card">
    <div style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Expected
      Yield</div>
    <div style="font-size: 2rem; font-weight: 900; color: var(--primary);">₹{{ total_expected_rent|floatformat:0 }}
    </div>
  </div>
  <div class="card-premium stat-card" style="border-top-color: var(--success);">
    <div style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Realized
      Revenue</div>
    <div style="font-size: 2rem; font-weight: 900; color: var(--success);">₹{{ total_collected|floatformat:0 }}</div>
  </div>
  <div class="card-premium stat-card" style="border-top-color: var(--danger);">
    <div style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Accounts
      Receivable</div>
    <div style="font-size: 2rem; font-weight: 900; color: var(--danger);">₹{{ total_pending|floatformat:0 }}</div>
  </div>
  <div class="card-premium stat-card">
    <div style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Efficiency
    </div>
    <div style="font-size: 2rem; font-weight: 900; color: var(--primary);">{{ collection_efficiency|floatformat:1 }}%
    </div>
  </div>
</div>

<div class="perf-grid">
  <div class="perf-chart-container">
    <h3 class="font-luxury" style="margin-bottom: 1.5rem; color: var(--primary);">Occupancy Distribution</h3>
    <div style="height: 300px; display: flex; align-items: flex-end; gap: 2rem;">
      <!-- Simple CSS Bar Chart for distribution -->
      {% for b_name, count in building_occupancy.items %}
      <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
        <div
          style="width: 100%; background: var(--grad-primary); border-radius: 4px 4px 0 0; height: {% widthratio count 10 100 %}%; transition: height 1s;">
        </div>
        <span style="font-size: 0.65rem; font-weight: 800;">Bldg {{ b_name }}</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="perf-chart-container" style="display: flex; flex-direction: column; justify-content: center;">
    <h3 class="font-luxury" style="margin-bottom: 1rem; color: var(--primary);">Complex Health</h3>
    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 2rem;">Current performance compared to peak
      capacity periods.</p>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      <div>
        <div
          style="display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 800; margin-bottom: 0.5rem;">
          <span>RENTAL FLOW</span>
          <span>{{ collection_efficiency|floatformat:0 }}%</span>
        </div>
        <div style="height: 8px; background: var(--bg-main); border-radius: 4px; overflow: hidden;">
          <div style="width: {{ collection_efficiency }}%; height: 100%; background: var(--success);"></div>
        </div>
      </div>
      <div>
        <div
          style="display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 800; margin-bottom: 0.5rem;">
          <span>UNIT UTILIZATION</span>
          <span>{{ occupancy_rate|floatformat:0 }}%</span>
        </div>
        <div style="height: 8px; background: var(--bg-main); border-radius: 4px; overflow: hidden;">
          <div style="width: {{ occupancy_rate }}%; height: 100%; background: var(--primary);"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card-premium glass-panel" style="padding: 0; overflow: hidden;">
  <div
    style="padding: 1.5rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
    <h2 class="font-luxury" style="color: var(--primary); font-size: 1.25rem;">Detailed Unit Audit</h2>
    <span class="metric-bubble">{{ room_data|length }} Units Scanned</span>
  </div>
  <div style="overflow-x: auto;">
    <table class="data-table-luxury">
      <thead>
        <tr>
          <th>Room</th>
          <th>Type</th>
          <th>Primary Resident</th>
          <th>Price Point</th>
          <th>Payment Status</th>
          <th>Net Status</th>
        </tr>
      </thead>
      <tbody>
        {% for rd in room_data %}
        <tr>
          <td data-label="Room" style="font-weight: 800; color: var(--primary);">{{ rd.room_number }}</td>
          <td data-label="Type">{{ rd.room_type }}</td>
          <td data-label="Resident" style="font-weight: 700;">{{ rd.active_guest|default:"—" }}</td>
          <td data-label="Price">₹{{ rd.price }}</td>
          <td data-label="Payment">₹{{ rd.paid|floatformat:0 }} / ₹{{ rd.expected|floatformat:0 }}</td>
          <td data-label="Net Status">
            {% if rd.balance <= 0 %} <span class="badge-premium badge-success" style="font-size: 0.65rem;">CLEAR</span>
              {% else %}
              <span class="badge-premium badge-danger" style="font-size: 0.65rem;">DUE ₹{{ rd.balance|floatformat:0
                }}</span>
              {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}