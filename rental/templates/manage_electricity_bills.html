{% extends 'base.html' %}
{% load static %}

{% block title %}Utility Matrix - Panesar PG{% endblock %}

{% block extra_head %}
<style>
  /* Page Specific Refinements */
  .utility-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .utility-card {
    border-top: 4px solid #f59e0b;
  }

  .bill-history {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 1rem;
    background: var(--bg-main);
    padding: 0.75rem;
    border-radius: var(--radius-md);
  }

  .bill-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: var(--bg-canvas);
    margin-bottom: 0.4rem;
    border: 1px solid var(--border-subtle);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
  }

  .input-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .input {
    width: 100%;
    padding: 0.625rem;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    font-size: 0.8125rem;
  }

  @media (max-width: 640px) {
    .utility-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<header class="card-premium glass-panel" style="margin-bottom: 2.5rem; padding: 2.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1 class="font-luxury text-luxury" style="font-size: 2.5rem;">Utility Matrix</h1>
      <p style="color: var(--text-muted); font-weight: 500;">Electricity meter tracking and resource billing management.
      </p>
    </div>
    <div style="display: flex; gap: 1rem;">
      <button onclick="openModal('addBillModal')" class="btn-premium btn-premium-primary">+ Gen. Monthly Bill</button>
      <a href="{% url 'dashboard' %}" class="btn-premium btn-premium-secondary">← Dashboard</a>
    </div>
  </div>
</header>

<div class="utility-grid">
  {% for data in bill_stats %}
  <div class="card-premium utility-card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
      <div>
        <h3 class="font-luxury" style="font-size: 1.25rem; color: var(--primary);">Room {{ data.room.number }}</h3>
        <p style="font-size: 0.65rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase;">{% if
          data.tenant %}{{ data.tenant.full_name }}{% else %}Vacant{% endif %}</p>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted);">Current Reading</div>
        <div style="font-size: 1.125rem; font-weight: 900; color: var(--text-main);">{{ data.latest_reading|default:"0"
          }} <span style="font-size: 0.65rem; font-weight: 600;">units</span></div>
      </div>
    </div>

    <div style="background: var(--bg-main); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
      <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
        <span style="color: var(--text-muted); font-weight: 600;">Total Billed</span>
        <span style="font-weight: 800;">₹{{ data.total_billed|floatformat:0 }}</span>
      </div>
    </div>

    <div class="bill-history">
      {% for bill in data.recent_bills %}
      <div class="bill-row">
        <div>{{ bill.month|date:"M Y" }}</div>
        <div style="font-weight: 800;">₹{{ bill.amount }}</div>
        <div style="color: var(--text-muted);">{{ bill.units_consumed }}u</div>
      </div>
      {% empty %}
      <div
        style="text-align: center; color: var(--text-muted); font-size: 0.7rem; padding: 0.5rem; font-style: italic;">No
        bills found.</div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Bill Modal -->
<div id="addBillModal" class="modal-overlay" onclick="closeModal(event)">
  <div class="card-premium modal-content glass-panel" onclick="event.stopPropagation()"
    style="max-width: 450px; padding: 2.5rem;">
    <h2 class="font-luxury text-luxury" style="font-size: 2rem; margin-bottom: 2rem;">Utility Entry</h2>
    <form id="billForm">
      {% csrf_token %}
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Unit
          No / Room</label>
        <select name="room_id" id="formRoomId" class="input" required onchange="updateReadings()">
          <option value="">Select Room...</option>
          {% for room in rooms %}<option value="{{ room.id }}"
            data-last="{{ room.electricitybill_set.last.ending_reading|default:'13' }}">Room {{ room.number }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="input-group">
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Start
            Reading</label>
          <input type="number" name="starting_reading" id="formStartReading" class="input" required value="13"
            step="0.01">
        </div>
        <div class="form-group">
          <label style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">End
            Reading</label>
          <input type="number" name="ending_reading" id="formEndReading" class="input" required step="0.01">
        </div>
      </div>

      <div class="input-group">
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Month</label>
          <input type="month" name="billing_month" class="input" required value="{% now 'Y-m' %}">
        </div>
        <div class="form-group">
          <label style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Rate
            (₹/u)</label>
          <input type="number" name="rate_per_unit" class="input" value="6" step="0.5">
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button type="submit" class="btn-premium btn-premium-primary" style="flex: 2;">Generate Bill</button>
        <button type="button" onclick="document.getElementById('addBillModal').style.display='none'"
          class="btn-premium btn-premium-secondary" style="flex: 1;">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function closeModal(e) { if (e.target.id === 'addBillModal') e.target.style.display = 'none'; }
  function openModal(id) { document.getElementById(id).style.display = 'flex'; }

  function updateReadings() {
    const sel = document.getElementById('formRoomId');
    const opt = sel.options[sel.selectedIndex];
    if (opt && opt.dataset.last) {
      document.getElementById('formStartReading').value = opt.dataset.last;
      document.getElementById('formEndReading').value = parseFloat(opt.dataset.last) + 50;
    }
  }

  document.getElementById('billForm').onsubmit = async (e) => {
    e.preventDefault();
    const res = await fetch('{% url "create_electricity_bill" %}', { method: 'POST', body: new FormData(e.target) });
    const data = await res.json();
    if (data.success) location.reload();
    else alert('Error: ' + data.message);
  };
</script>
{% endblock %}