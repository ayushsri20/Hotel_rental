{% extends 'base.html' %}
{% load static %}

{% block title %}Rental Ledger - Panesar PG{% endblock %}

{% block extra_head %}
<style>
  /* Page Specific Refinements */
  .ledger-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
  }

  .ledger-card {
    padding: 0;
    overflow: hidden;
  }

  .ledger-header {
    padding: 1.5rem;
    border-bottom: 2px solid var(--border-subtle);
  }

  .payment-history {
    max-height: 250px;
    overflow-y: auto;
    padding: 1rem;
    background: var(--bg-main);
  }

  .payment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    background: var(--bg-canvas);
    margin-bottom: 0.5rem;
    border: 1px solid var(--border-subtle);
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  /* Modal Styling */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(8px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 1rem;
  }

  .modal-content {
    width: 100%;
    max-width: 500px;
    padding: 2.5rem;
  }

  .input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
  }

  @media (max-width: 640px) {
    .ledger-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<header class="card-premium glass-panel" style="margin-bottom: 2.5rem; padding: 2.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1 class="font-luxury text-luxury" style="font-size: 2.5rem;">Rental Ledger</h1>
      <p style="color: var(--text-muted); font-weight: 500;">Financial tracking and historical payment records.</p>
    </div>
    <div style="display: flex; gap: 1rem;">
      <button onclick="openModal('addPaymentModal')" class="btn-premium btn-premium-primary">Record New Payment</button>
      <a href="{% url 'dashboard' %}" class="btn-premium btn-premium-secondary">‚Üê Dashboard</a>
    </div>
  </div>
</header>

<div class="ledger-grid">
  {% for payment in monthly_payments %}
  <div class="card-premium ledger-card">
    <div class="ledger-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h3 class="font-luxury" style="font-size: 1.25rem; color: var(--primary);">Room {{ payment.room.number }}</h3>
          <p style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700;">{{ payment.month|date:"F Y" }}
            Cycle</p>
        </div>
        <span
          class="badge-premium {% if payment.payment_status == 'paid' %}badge-success{% elif payment.payment_status == 'partial' %}badge-warning{% else %}badge-danger{% endif %}">
          {{ payment.get_payment_status_display }}
        </span>
      </div>
    </div>

    <div style="padding: 1.5rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
        <div style="text-align: center; flex: 1;">
          <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">
            Expected</div>
          <div style="font-weight: 800; color: var(--text-main);">‚Çπ{{ payment.rent_amount }}</div>
        </div>
        <div
          style="text-align: center; flex: 1; border-left: 1px solid var(--border-subtle); border-right: 1px solid var(--border-subtle);">
          <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Paid
          </div>
          <div style="font-weight: 800; color: var(--success);">‚Çπ{{ payment.paid_amount }}</div>
        </div>
        <div style="text-align: center; flex: 1;">
          <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">
            Pending</div>
          <div style="font-weight: 800; color: var(--danger);">‚Çπ{{ payment.remaining_amount }}</div>
        </div>
      </div>

      <div class="payment-history">
        {% for record in payment.paymentrecord_set.all %}
        <div class="payment-row">
          <div>
            <div style="font-weight: 800; font-size: 0.8125rem;">‚Çπ{{ record.payment_amount }}</div>
            <div style="font-size: 0.65rem; color: var(--text-muted);">{{ record.payment_date|date:"d M, Y" }} ‚Ä¢ {{
              record.get_payment_method_display }}</div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn-premium btn-premium-secondary edit-record-btn" data-id="{{ record.id }}"
              data-amount="{{ record.payment_amount }}" data-date="{{ record.payment_date|date:'Y-m-d' }}"
              data-method="{{ record.payment_method }}" data-notes="{{ record.notes }}">Edit</button>
            <button onclick="deleteRecord('{{ record.id }}')" class="btn-premium btn-premium-secondary"
              style="padding: 0.25rem 0.6rem; font-size: 0.65rem; border-color: var(--danger); color: var(--danger);">Del</button>
          </div>
        </div>
        {% empty %}
        <div
          style="text-align: center; color: var(--text-muted); font-size: 0.75rem; padding: 1rem; font-style: italic;">
          No payments recorded yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% empty %}
  <div style="grid-column: 1/-1; text-align: center; padding: 5rem;" class="card-premium glass-panel">
    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üíé</div>
    <h3 class="font-luxury" style="color: var(--primary); font-size: 1.5rem;">All Clear</h3>
    <p style="color: var(--text-muted); font-weight: 500;">No pending or partial payments found for the current cycle.
    </p>
  </div>
  {% endfor %}
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" class="modal-overlay" onclick="closeModal(event)">
  <div class="card-premium modal-content glass-panel" onclick="event.stopPropagation()">
    <h2 class="font-luxury text-luxury" style="font-size: 2rem; margin-bottom: 2rem;">Record Payment</h2>
    <form id="paymentForm">
      {% csrf_token %}
      <div class="form-group" style="margin-bottom: 1.25rem;">
        <label
          style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Monthly
          Bill ID</label>
        <select name="payment_id" id="formPaymentId" class="input" required>
          <option value="">Select Monthly Bill...</option>
          {% for p in monthly_payments %}
          {% if p.payment_status != 'paid' %}
          <option value="{{ p.id }}">Room {{ p.room.number }} - {{ p.month|date:"F Y" }} (Pending: ‚Çπ{{
            p.remaining_amount }})</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Amount
            Paid (‚Çπ)</label>
          <input type="number" name="payment_amount" class="input" required>
        </div>
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Payment
            Date</label>
          <input type="date" name="payment_date" class="input" value="{% now 'Y-m-d' %}" required>
        </div>
      </div>
      <div class="form-group" style="margin-bottom: 2rem;">
        <label
          style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Method</label>
        <select name="payment_method" class="input">
          <option value="cash">Cash</option>
          <option value="upi">UPI / Online</option>
          <option value="bank_transfer">Bank Transfer</option>
        </select>
      </div>
      <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn-premium btn-premium-primary" style="flex: 2;">Record Transaction</button>
        <button type="button" onclick="document.getElementById('addPaymentModal').style.display='none'"
          class="btn-premium btn-premium-secondary" style="flex: 1;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Payment Modal -->
<div id="editPaymentModal" class="modal-overlay" onclick="closeModal(event)">
  <div class="card-premium modal-content glass-panel" onclick="event.stopPropagation()">
    <h2 class="font-luxury text-luxury" style="font-size: 2rem; margin-bottom: 2rem;">Edit Transaction</h2>
    <form id="editPaymentForm">
      {% csrf_token %}
      <input type="hidden" id="editRecordId" name="record_id">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Amount
            Paid (‚Çπ)</label>
          <input type="number" id="editAmount" name="payment_amount" class="input" required>
        </div>
        <div class="form-group">
          <label
            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Payment
            Date</label>
          <input type="date" id="editDate" name="payment_date" class="input" required>
        </div>
      </div>
      <div class="form-group" style="margin-bottom: 1.25rem;">
        <label
          style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Method</label>
        <select id="editMethod" name="payment_method" class="input">
          <option value="cash">Cash</option>
          <option value="upi">UPI / Online</option>
          <option value="bank_transfer">Bank Transfer</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom: 2rem;">
        <label
          style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Notes</label>
        <textarea id="editNotes" name="notes" class="input" style="height: 80px; resize: none;"></textarea>
      </div>
      <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn-premium btn-premium-primary" style="flex: 2;">Save Changes</button>
        <button type="button" onclick="document.getElementById('editPaymentModal').style.display='none'"
          class="btn-premium btn-premium-secondary" style="flex: 1;">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function closeModal(e) {
    if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
  }
  function openModal(id) { document.getElementById(id).style.display = 'flex'; }

  document.getElementById('paymentForm').onsubmit = async (e) => {
    e.preventDefault();
    const res = await fetch('{% url "record_payment" %}', { method: 'POST', body: new FormData(e.target) });
    if ((await res.json()).success) location.reload(); else alert('Error: Record saving failed');
  };

  document.addEventListener('click', e => {
    if (e.target.classList.contains('edit-record-btn')) {
      const b = e.target.dataset;
      document.getElementById('editRecordId').value = b.id;
      document.getElementById('editAmount').value = b.amount;
      document.getElementById('editDate').value = b.date;
      document.getElementById('editMethod').value = b.method;
      document.getElementById('editNotes').value = b.notes;
      openModal('editPaymentModal');
    }
  });

  document.getElementById('editPaymentForm').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('editRecordId').value;
    const res = await fetch(`/api/payment-record/${id}/update/`, {
      method: 'POST',
      body: new FormData(e.target),
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    if ((await res.json()).success) location.reload(); else alert('Error: Update failed');
  };

  async function deleteRecord(id) {
    if (!confirm('Permanently delete this payment record? This will adjust the monthly balance.')) return;
    const res = await fetch(`/api/payment-record/${id}/delete/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    if ((await res.json()).success) location.reload(); else alert('Error: Deletion failed');
  }
</script>
{% endblock %}